---
services:
  cert-gen:
    build:
      context: ./cert-gen
      dockerfile: Dockerfile.cert-gen
    container_name: cert-gen
    volumes:
      - ./certs:/certs #自動生成的證書輸出目錄
    restart: "no"

  nginx:
    image: linuxserver/nginx
    container_name: mb3admin.com #兩個容器間互聯，實現免改 hosts/DNS 指定 emby 服務端訪問本地偽造的 mb3admin.com 網站
    depends_on:
      cert-gen:
        condition: service_completed_successfully
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
    volumes:
      - ./nginx:/config #nginx 的配置目錄，已經部署好偽造證書與 emby 授權的回應
      - ./certs:/config/keys:ro #自動生成的偽造證書與密鑰目錄
    # ports:
    #   - 443:443
    # 單純破解與該容器互聯的 emby 服務端情況下，無需映射 https 的 443 埠出來
    restart: unless-stopped

  emby:
    image: linuxserver/emby
    depends_on:
      cert-gen:
        condition: service_completed_successfully
      nginx:
        condition: service_started
    container_name: emby
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Taipei
    volumes:
      - ./certs:/mnt/certs:ro # 掛載證書目錄供 init 腳本使用
      - ./emby-init:/custom-cont-init.d:ro # 注入初始化腳本以安裝證書
      - ./emby:/config #emby 的配置目錄
      - ./crypto.js:/app/emby/system/dashboard-ui/modules/polyfills/crypto.js:ro #前端破解腳本
      - ./data:/data   #按需配置媒體目錄
      - /path/to/movies:/data/movies # 電影媒體庫，請修改為您的實際路徑
      - /path/to/tvshows:/data/tvshows # 電視劇媒體庫，請修改為您的實際路徑
    ports:
      - 8096:8096
    devices:
      - /dev/dri:/dev/dri
    restart: unless-stopped

#其他參數的具體含義，請查閱容器的官方文檔
#使用到的 nginx 容器       https://hub.docker.com/r/linuxserver/nginx
#使用到的 emby 容器        https://hub.docker.com/r/linuxserver/emby
